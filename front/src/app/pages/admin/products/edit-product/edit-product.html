<!-- Loading State -->
<div class="loading-container" *ngIf="loadingProduct || loadingTypes">
  <div class="spinner"></div>
  <p>Cargando producto...</p>
</div>

<!-- Form Container -->
<div class="form-container" *ngIf="!loadingProduct && !loadingTypes && productLoaded">
  <!-- Back Button -->
  <button type="button" class="back-button" (click)="goBack()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="19" y1="12" x2="5" y2="12"></line>
      <polyline points="12 19 5 12 12 5"></polyline>
    </svg>
    Volver a la lista
  </button>

  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form" novalidate>
    <h2>Editar producto</h2>

    <!-- Código (readonly) -->
    <label>Código del Producto</label>
    <input formControlName="proCode" type="text" readonly class="readonly-field" />
    <small class="helper-text">El código del producto no se puede modificar</small>

    <!-- Nombre -->
    <label>Nombre</label>
    <input
      formControlName="proName"
      type="text"
      maxlength="50"
      placeholder="Ej: iPhone 15 Pro"
    />
    <div *ngIf="submitted && productForm.controls['proName'].invalid" class="error-message">
      <small *ngIf="productForm.controls['proName'].errors?.['required']">El nombre es obligatorio.</small>
      <small *ngIf="productForm.controls['proName'].errors?.['minlength']">Debe tener al menos 2 caracteres.</small>
      <small *ngIf="productForm.controls['proName'].errors?.['maxlength']">Máximo 50 caracteres permitidos.</small>
    </div>

    <!-- Descripción -->
    <label>Descripción</label>
    <textarea
      formControlName="descript"
      placeholder="Describe el producto..."
      rows="4"
      maxlength="200"
    ></textarea>
    <div *ngIf="submitted && productForm.controls['descript'].invalid" class="error-message">
      <small *ngIf="productForm.controls['descript'].errors?.['required']">La descripción es obligatoria.</small>
      <small *ngIf="productForm.controls['descript'].errors?.['minlength']">Debe tener al menos 5 caracteres.</small>
    </div>

    <!-- Marca -->
    <label>Marca</label>
    <input
      formControlName="proMark"
      type="text"
      maxlength="30"
      placeholder="Ej: Apple"
    />
    <div *ngIf="submitted && productForm.controls['proMark'].invalid" class="error-message">
      <small *ngIf="productForm.controls['proMark'].errors?.['required']">La marca es obligatoria.</small>
      <small *ngIf="productForm.controls['proMark'].errors?.['minlength']">Debe tener al menos 2 caracteres.</small>
      <small *ngIf="productForm.controls['proMark'].errors?.['maxlength']">Máximo 30 caracteres permitidos.</small>
    </div>

    <!-- Precio -->
    <label>Precio</label>
    <input
      formControlName="proPrice"
      type="number"
      placeholder="Ej: 5999"
      (keypress)="onlyNumbers($event)"
      min="1"
      max="20000000"
    />
    <div *ngIf="submitted && productForm.controls['proPrice'].invalid" class="error-message">
      <small *ngIf="productForm.controls['proPrice'].errors?.['required']">El precio es obligatorio.</small>
      <small *ngIf="productForm.controls['proPrice'].errors?.['min']">Debe ser mayor que 0.</small>
      <small *ngIf="productForm.controls['proPrice'].errors?.['max']">No puede superar los $20,000,000.</small>
      <small *ngIf="productForm.controls['proPrice'].errors?.['pattern']">Solo se permiten números.</small>
    </div>

    <!-- Tipo -->
    <label>Tipo</label>
    <select formControlName="typeCode">
      <option value="">Selecciona tipo</option>
      <option *ngFor="let type of productTypes" [value]="type.typeCode">
        {{ type.typeName }}
      </option>
    </select>
    <div *ngIf="submitted && productForm.controls['typeCode'].invalid" class="error-message">
      <small>Selecciona un tipo de producto.</small>
    </div>

    <!-- Imagen -->
    <label>URL Imagen</label>
    <input
      formControlName="proImg"
      type="url"
      placeholder="https://imagen.com/ejemplo.jpg"
      pattern="https?://.+"
    />
    <div *ngIf="submitted && productForm.controls['proImg'].invalid" class="error-message">
      <small *ngIf="productForm.controls['proImg'].errors?.['required']">La URL de imagen es obligatoria.</small>
      <small *ngIf="productForm.controls['proImg'].errors?.['pattern']">Debe ser una URL válida (https://...)</small>
    </div>

    <!-- Estado -->
    <label>Estado</label>
    <select formControlName="status">
      <option value="A">Activo</option>
      <option value="I">Inactivo</option>
    </select>

    <!-- Action Buttons -->
    <div class="button-group">
      <button type="button" class="btn-cancel" (click)="goBack()">
        Cancelar
      </button>
      <button type="submit" class="btn-submit" [disabled]="productForm.invalid && submitted">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Actualizar producto
      </button>
    </div>
  </form>

  <!-- Preview -->
  <div class="preview-section">
    <h3>Vista previa</h3>
    <div class="preview" *ngIf="previewImage; else noPreview">
      <img [src]="previewImage" alt="Vista previa del producto" />
    </div>
    <ng-template #noPreview>
      <div class="no-preview">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <p>Sin imagen</p>
      </div>
    </ng-template>

    <!-- Product Info Preview -->
    <div class="info-preview" *ngIf="productForm.get('proName')?.value">
      <div class="preview-item">
        <span class="preview-label">Nombre:</span>
        <span class="preview-value">{{ productForm.get('proName')?.value || '-' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-label">Marca:</span>
        <span class="preview-value">{{ productForm.get('proMark')?.value || '-' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-label">Precio:</span>
        <span class="preview-value">${{ productForm.get('proPrice')?.value || 0 | number }}</span>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div *ngIf="showToast" class="toast" [ngClass]="toastType">
  <img
    *ngIf="toastType === 'success'"
    class="toast-icon"
    src="https://cdn-icons-png.flaticon.com/512/845/845646.png"
    alt="Éxito"
  />
  <img
    *ngIf="toastType === 'error'"
    class="toast-icon"
    src="https://cdn-icons-png.flaticon.com/512/463/463612.png"
    alt="Error"
  />
  <p>{{ toastMessage }}</p>
</div>
